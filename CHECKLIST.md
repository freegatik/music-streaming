# Чеклист для проверки лабораторной

Порядок проверки всех функций приложения. Для тестирования используй Postman коллекцию из папки `postman/`.

## Начало работы

Перед проверкой нужно убедиться, что всё готово:

1. PostgreSQL должен быть запущен, база `musicdb` создана и доступна. Проверить можно командой `psql -d musicdb`.

2. Приложение запускается без ошибок на порту 8081. Если порт занят, можно освободить его через `lsof -ti:8081 | xargs kill -9`.

3. После запуска в базе автоматически создаются тестовые данные - несколько артистов, альбомов и треков. Их должно быть видно через публичные эндпоинты.

4. Postman коллекция импортирована. Файл `postman/music-streaming-api.postman_collection.json` нужно импортировать в Postman и настроить переменные: `baseUrl` (обычно `http://localhost:8081`), `username` и `password` (заполнишь после регистрации).

## Регистрация

Сначала проверь регистрацию через `POST /api/auth/register`. Этот эндпоинт публичный, авторизация не нужна.

Пример запроса:
```json
{
    "username": "student",
    "password": "Student123!@#",
    "email": "student@example.com",
    "firstName": "Student",
    "lastName": "Test"
}
```

Ожидаемо: статус 201, пользователь создан, роль USER по умолчанию. В ответе не должно быть пароля.

Валидация пароля должна отклонить:
- Короткие пароли (меньше 8 символов)
- Пароли без цифр
- Пароли без букв
- Пароли без спецсимволов

Также проверь, что нельзя создать пользователя с одинаковым username или email - должно вернуть ошибку валидации.

После успешной регистрации сохрани username и password в переменных коллекции Postman для последующих запросов.

Basic Auth: попробуй сделать любой защищённый запрос без авторизации - должно вернуть 401. С правильными credentials должно работать.

## Публичные эндпоинты

Всё нижеперечисленное должно работать без Basic Auth:

Артисты:
- `GET /api/artists` - список всех
- `GET /api/artists/1` - детали конкретного
- `GET /api/artists/search?name=Mac` - поиск по имени
- `GET /api/artists/country/Canada` - по стране

Альбомы:
- `GET /api/albums` - список
- `GET /api/albums/1` - детали
- `GET /api/albums/artist/1` - альбомы артиста
- `GET /api/albums/search?title=Salad` - поиск

Треки:
- `GET /api/tracks` - список
- `GET /api/tracks/1` - детали
- `GET /api/tracks/artist/1` - треки артиста
- `GET /api/tracks/album/1` - треки альбома
- `GET /api/tracks/genre/Indie` - по жанру
- `GET /api/tracks/search?title=Chamber` - поиск

Плейлисты:
- `GET /api/playlists/public` - только публичные

## CRUD операции

### Каталог (только ADMIN)

Обычный пользователь с ролью USER не должен иметь доступа к созданию/изменению/удалению артистов, альбомов и треков. Все эти запросы должны возвращать 403:

- `POST /api/artists`, `PUT /api/artists/1`, `DELETE /api/artists/1`
- `POST /api/albums?artistId=1`, `PUT /api/albums/1`, `DELETE /api/albums/1`
- `POST /api/tracks?artistId=1&albumId=1`, `PUT /api/tracks/1`, `DELETE /api/tracks/1`

Для проверки ADMIN операций нужна роль ADMIN - её придётся установить вручную в базе данных.

### Плейлисты

Создание: `POST /api/playlists` создаёт плейлист автоматически для текущего пользователя (тот, кто авторизован через Basic Auth). Владелец устанавливается автоматически.

Просмотр: доступны эндпоинты для получения списка плейлистов, деталей по ID, поиска по имени, плейлистов конкретного пользователя и треков в плейлисте.

Изменение и удаление: пользователь может изменять и удалять только свои плейлисты. Попытка изменить или удалить чужой плейлист должна вернуть 403.

### Треки в плейлисте

Добавление: через `POST /api/playlists/{id}/tracks?trackId=1`. Можно указать позицию через параметр `position`. Трек должен добавиться, если его там ещё нет.

Удаление: `DELETE /api/playlists/{id}/tracks/{position}` удаляет трек и пересчитывает позиции остальных.

Опять же - эти операции доступны только владельцу плейлиста, для чужих плейлистов вернётся 403.

### Пользователи

Список всех пользователей (`GET /api/users`) доступен только ADMIN. USER получит 403.

Получение по ID или email: пользователь может увидеть только свои данные. Чужие вернут 403.

Изменение и удаление: можно менять и удалять только свой аккаунт.

## Бизнес-операции

### Перестановка трека

`POST /api/playlists/{id}/tracks/move` с телом:
```json
{
    "trackId": 1,
    "newPosition": 0
}
```

Трек перемещается на указанную позицию, остальные треки сдвигаются. Возвращается обновлённый список треков плейлиста. Должна работать только для своих плейлистов.

### Перемешивание

`POST /api/playlists/{id}/shuffle` перемешивает треки в плейлисте случайным образом. Позиции должны быть последовательными (0, 1, 2...), все треки остаются в плейлисте.

### Клонирование

`POST /api/playlists/{id}/clone` с телом:
```json
{
    "name": "Моя копия",
    "description": "Скопированный плейлист",
    "makePublic": false
}
```

Создаёт копию плейлиста для текущего пользователя. Треки копируются с теми же позициями. Можно клонировать публичные плейлисты или свои. Приватные чужие плейлисты клонировать нельзя (403).

### Daily Mix

`POST /api/users/{userId}/mix` создаёт плейлист из треков, которые есть в других плейлистах пользователя. Тело запроса:
```json
{
    "name": "Daily Mix",
    "description": "Автоподборка",
    "genre": "Indie",
    "limit": 10,
    "makePublic": false
}
```

Если указан жанр, выбираются треки этого жанра. Количество не должно превышать лимит. Генерировать микс можно только для себя.

### Статистика

`GET /api/users/{userId}/summary` возвращает статистику по библиотеке: сколько плейлистов, треков, уникальных артистов. Подсчёты должны быть корректными. Просмотр статистики доступен только для своего аккаунта (кроме ADMIN).

## Безопасность

USER может работать только со своими данными и плейлистами. Не может управлять каталогом (артисты, альбомы, треки) и не видит список всех пользователей.

ADMIN имеет полный доступ ко всем операциям.

Защищённые эндпоинты требуют Basic Auth. Неправильные credentials или их отсутствие вернёт 401. CSRF для API эндпоинтов отключён (так как используется Basic Auth).

Валидация должна проверять все обязательные поля, формат email, максимальную длину строк. Ошибки валидации должны возвращать понятные сообщения.

Пароль проверяется на минимальную длину (8 символов), наличие цифры, буквы и спецсимвола.

## Транзакционность

Бизнес-операции должны быть атомарными. Если что-то пошло не так, все изменения откатываются. Например, при перемешивании плейлиста все позиции изменяются одновременно, а не по одной. При клонировании все треки копируются или не копируется ничего.

## Полный сценарий

Для проверки работы всего функционала пройдись по такому сценарию:

1. Зарегистрируй пользователя
2. Посмотри публичный каталог (артисты, альбомы, треки)
3. Создай плейлист
4. Добавь в него треки
5. Переставь треки местами
6. Перемешай плейлист
7. Склонируй публичный плейлист (если есть)
8. Сгенерируй Daily Mix
9. Посмотри статистику своей библиотеки
10. Попробуй получить доступ к чужим данным - должно вернуть 403

## Полезные команды

Проверка, что приложение запущено:
```bash
curl http://localhost:8081/api/artists
```

Проверка базы:
```bash
psql -d musicdb -c "SELECT COUNT(*) FROM users;"
```

Проверка порта:
```bash
lsof -ti:8081
```

Если всё из этого списка работает как ожидается, лабораторная выполнена корректно.
